[General]
SyntaxVersion=2
BeginHotkey=121
BeginHotkeyMod=0
PauseHotkey=19
PauseHotkeyMod=0
StopHotkey=123
StopHotkeyMod=0
RunOnce=1
EnableWindow=
MacroID=612dd383-c7e7-4b52-b790-4639e13dfc47
Description=TouKen_cn
Enable=1
AutoRun=0
[Repeat]
Type=0
Number=1
[SetupUI]
Type=1
QUI=main
[Relative]
SetupOCXFile=
[Comment]

[UIPackage]
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


[Script]
TOTALPOS = 15
WAITETIME = 10000
DELTAX = 0
DELTAY = 0
HWND = 0
age = 0
stage = 0
CheckPointX = 0
CheckPointY = 0
TotalFight = 0
TotalTouKen = 0
TempClickX = 0
TempClickY = 0
SizeX = 0
SizeY = 0
firstFlag = 0
AgePointX = array(- 202 , - 84 )
AgePointY = array(119, 119)
StagePointX = array(- 140 , 100, - 140 , 100)
StagePointY = array(250, 250, 350, 350)
FormationX = array(- 250 , 15, 276, - 250 , 15, 276)
FormationY = array(157, 157, 157, 340, 340, 340)
EquipList = array("Rider0.bmp", "Infantry0.bmp", "Rider1.bmp", "Infantry1.bmp", "Rider2.bmp", "Infantry2.bmp","Equip0.bmp","Equip1.bmp","Equip2.bmp")
SpaceBlank = array("SpaceBlank0.bmp", "SpaceBlank1.bmp", "SpaceBlank2.bmp")
CheckPointName = array("本丸","出阵准备","地图选择","出阵确认","大地图","阵型选择","战斗结算","出阵前刀装缺失","刀装","大阪城重复通关","新刀发现","新刀发现","大阪城首次通关")
Sub Init//初始化设置
	PutToList "开始初始化"
	Call Plugin.RegDll.Reg("D:\TouKenTool\image_cn\dm.dll")//调用大漠插件，在按键精灵中使用 
	Set dm = createobject("dm.dmsoft")//用大漠插件创建一个对象dm 
	dm_ret = dm.SetPath("D:\TouKenTool\image_cn")// 设置全局路径，以后你找图用的图片都默认是test目录里的图片了，否则你要用绝对路径d:\test\1.bmp来该表示图片  
	dm_ret = dm.LoadPic("*.bmp")// 字面意思是加载test目录下的所有图片  
	//Hwnd = dm.GetPointWindow(zbx,zby)//用大漠软件获取给定坐标(zbx,zby)的窗口句柄,保存在Hwnd里  
	HWND = Plugin.Window.MousePoint()'得到鼠标所在位置的窗口句柄
	PutToList "获取到游戏窗口"&Cstr(HWND)
	Call Plugin.Window.Move(HWND, 0, 0)  // 把窗口移到屏幕的(0，0)，即左上角  
	dm_ret = dm.BindWindow(HWND,"gdi","windows","windows",0) //这句用来绑定辅助操作的对象窗口
	If dm_ret = 1 Then 
		PutToList "成功绑定大漠插件"
	Else 
		PutToList "绑定大漠插件失败，脚本退出"
		EndScript
	End If

	s = Plugin.Window.GetClientRect(HWND)//获取窗口坐标
	PutToList "获取到窗口坐标"
	XYArray = Split(s, "|", - 1 , 1)//窗口点击偏移
	DELTAX = XYArray(0)
	DELTAY = XYarray(1)
	SizeX = XYArray(2) - XYArray(0)
	SizeY = XYArray(3) - XYArray(1)
	PutToList "窗口大小："&Cstr(SizeX)&"*"&Cstr(SizeY)
	PutToList Cstr(XYarray(0))&" "&Cstr(XYarray(1))&" "&Cstr(XYarray(2))&" "&Cstr(XYarray(3))
	PutToList "获取到全局偏移"
	age = main.AgeList.ListIndex //获取时代
	PutToList "获取到时代"
	stage = main.StageList.ListIndex//获取战场
	PutToList "获取到战场"
	targetStep = main.StepList.ListIndex//获取前进次数
	PutToList "获取到前进次数"
	formation = main.FormationList.ListIndex//获取阵型
	PutToList "获取到默认阵型"
	PutToList "初始化完毕"
End Sub

Sub Click(intX, intY)
	TempClickX = CheckPointX + intX
	TempClickY = CheckPointY + intY
	//MoveTo TempClickX + DELTAX, TempClickY + DELTAY
	dm.MoveTo TempClickX, TempClickY
	dm.LeftClick
	//Plugin.Bkgnd.LeftClick HWND, TempClickX, TempClickY
	//PutToList "点击(" & Cstr(TempClickX) & "," & Cstr(TempClickY) & ")"
	Delay 1000
End Sub

Sub ReClick
	PutToList "没有响应，再次点击"
	Plugin.Bkgnd.LeftClick HWND, TempClickX, TempClickY
End Sub

Function GetNowPos//获取当前状态
	PutToList "正在获取当前状态..."
	GetNowPos = 0
	intX = - 1 
	intY = - 1 
	i = 0
	While intX < 0 and intY < 0
		For i = 0 To TOTALPOS - 1
			dm.FindPic 0, 0, SizeX, SizeY, "CheckPoint" & Cstr(i) & ".bmp", 000000, 0.9, dir, intX, intY
			//FindPic 0, 0, 1024, 768, "Attachment:\CheckPoint" & Cstr(i) & ".bmp", 0.9, intX, intY
			If intX >= 0 and intY >= 0 Then 
				//CheckPointX = intX - DELTAX
				//CheckPointY = intY - DELTAY
				CheckPointX = intX
				CheckPointY = intY
				Exit For
			End If
		Next
		If intX < 0 and intY < 0 Then //点击空白处
			//ReClick
		End If
		//Delay 1000
	Wend
	GetNowPos = i
	PutToList "当前处在 " & CheckPointName(i)
	//PutToList "检查点坐标(" & Cstr(CheckPointX) & "," & Cstr(CheckPointY) & ")"
End Function

Function FindAndClick(image) //寻找并点击image : string
	intX = - 1 
	intY = - 1 
	PutToList "开始查找"&image
	//FindPic 0, 0, 1920, 1080, "Attachment:\" & image, 0.9, intX, intY
	dm.FindPic 0, 0, SizeX, SizeY, image, 000000, 0.9, dir, intX, intY
	If intX >= 0 and intY >= 0 Then 
		Delay 1000
		PutToList "恭喜，已找到" & image
		//dm.MoveTo intX - DELTAX, intY - DELTAY
		dm.MoveTo intX, intY
		dm.LeftClick
		//Plugin.Bkgnd.LeftClick HWND, intX - DELTAX , intY - DELTAY
		FindAndClick = 1
	Else 
		PutToList "抱歉，没有找到"&image
		FindAndClick = 0
	End If
End Function


Init //初始化设置
nowStep = 0
While True
	tempStep = GetNowPos()//获取当前状态
	//If tempStep = nowStep and nowStep <> 6 Then 
	If False Then 	
	Else 
		nowPos = tempStep
		Select Case nowPos
			Case 0 //处在本丸
				nowStep = 0
				Click 882, 59
			Case 1 //处在出阵图
				Click 0 , 0
			Case 2//处在时代选择
				If firstFlag = 0 Then 
					firstFlag = 1
					age = main.AgeList.ListIndex //获取时代
					PutToList "获取到时代"
					stage = main.StageList.ListIndex//获取战场
					PutToList "获取到战场"
					While FindAndClick("LeftArrow.bmp")
					Wend
					For i = 1 To age/2
						FindAndClick ("RightArrow.bmp")
					Next
					PutToList "点击时代"
					Click AgePointX(age Mod 2), AgePointY(age Mod 2)
					PutToList "点击地区"
					Click StagePointX(stage), StagePointY(stage)					
				End If
				PutToList "点击出阵"
				Click 300, 460
			Case 3 //处在出阵确认
				Click 244, 445
			Case 4 //处在大地图
				Click 0, 0
			Case 5//处在阵型选择
				formation = main.FormationList.ListIndex//获取阵型
				PutToList "获取到默认阵型"
				If formation = 6 Then 
					If FindAndClick("BestFormation.bmp") = 0
						Click FormationX(1), FormationY(1)
					End If
				Else
					Click FormationX(formation), FormationY(formation)
				End If
				
				nowStep = nowStep + 1
				TotalFight = TotalFight + 1
				main.TotalFight.Caption = Cstr(TotalFight) & "次"
				//PutToList "已经前进了" & Cstr(nowStep) & "次"
				//PutToList "已经战斗了" & Cstr(TotalFight) & "次"
				Delay 10000
			Case 6//处在结算界面
				targetStep = main.StepList.ListIndex//获取前进次数
				PutToList "获取到前进次数"
				If nowStep = targetStep and targetStep>0 Then 
					PutToList "返回本丸"
					Click 400, 330
					Click 400, 400
				Else 
					PutToList "继续行军"
					Click 180, 330
					Click 180, 400
				End If
			Case 7 //出阵前刀装缺失
				Click 0, 0
			Case 8//补充刀装
				Delay 2000
				While FindAndClick("equipment.bmp")
					Delay 2000
					For Si = 0 To 2
						While FindAndClick(SpaceBlank(Si))
							For i = 0 To 8
								If FindAndClick(EquipList(i)) Then
									Exit For
								End If
							Next
							Delay 2000
							FindAndClick ("ChangeEquip.bmp")
							Delay 2000
						Wend
					Next
					Delay 2000
					FindAndClick ("ReturnButton.bmp")
					Delay 2000
				Wend
				Delay 2000
				FindAndClick ("Gohome.bmp")
			Case 9//千两箱重复通关
				If main.OusakaLoop.Value Then 
					Click 80, - 160 //继续	
				Else 
					Click 300, - 160 //返回
				End If
			Case 10,11,13,14 //发现刀剑
				Click 0, 0
				TotalTouKen = TotalTouKen + 1
				PutToList "发现刀剑"
				main.TouKenNum.Caption = Cstr(TotalTouKen) & "把"
			Case 12//千两箱首次通关
				If main.OusakaLoop.Value Then 
					Click 80, - 160 //继续	
				Else 
					Click 300, - 160 //返回
				End If
		End Select
	End If
Wend


Sub PutToList(str)
	str = Cstr(Now) & " " & str
	If main.LogList.ListCount > 7 Then 
		main.LogList.RemoveItem 0
	End If
	main.LogList.AddItem str
	TracePrint str
	Call Plugin.Bkgnd.KeyPress(main.LogList.Hwnd, 40)
End Sub
